<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Tarif Öneri Uygulaması</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Georgia, serif; }
    body { background: #0d1117; color: #c9d1d9; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
    .container, .results-frame {
      background: #161b22;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
      width: 100%;
      max-width: 600px;
      margin-bottom: 1.5rem;
    }
    .container { padding: 2rem; }
    .container h1 { margin-bottom: 1rem; font-size: 1.8rem; text-align: center; color: #58a6ff; }
    .container p { margin-bottom: 0.5rem; }
    .container input {
      width: 100%; padding: 0.6rem; margin-bottom: 0.8rem;
      border: 1px solid #30363d; border-radius: 4px; font-size: 1rem;
      background: #0d1117; color: #c9d1d9;
    }
    .container button {
      width: 100%; padding: 0.7rem;
      background: #238636; color: #f0f6fc; border: none; border-radius: 4px;
      cursor: pointer; font-size: 1rem;
    }
    .container button:hover { background: #2ea043; }
    .contact { margin-top: 0.5rem; text-align: center; color: #8b949e; font-size: 0.9rem; }
    .contact a { color: #58a6ff; text-decoration: none; }
    /* Yeni uyarı satırı */
    #warning {
      margin-top: 0.5rem;
      text-align: center;
      color: #f0ad4e;
      font-size: 0.9rem;
      min-height: 1.2em;
    }

    .results-frame { display: none; padding: 2rem; }
    .results-frame h2 { font-size: 1.6rem; margin-bottom: 0.5rem; color: #58a6ff; }
    .hint { font-size: 0.9rem; margin-bottom: 1rem; color: #8b949e; }
    #message { margin-bottom: 1rem; font-style: italic; }
    #results { list-style: none; padding: 0; }
    #results li {
      background: #0d1117; margin-bottom: 1rem; padding: 1rem;
      border: 1px solid #30363d; border-radius: 6px;
    }
    .recipe-title {
      font-size: 1.3rem; margin-bottom: 0.6rem; color: #58a6ff;
      cursor: pointer;
    }
    .ings { display: flex; justify-content: space-between; }
    .ings div { width: 48%; }
    .ings strong { display: block; margin-bottom: 0.4rem; color: #ffea7f; }
    .ings ul { list-style: disc; margin-left: 1.2rem; }
    hr { border: none; border-top: 1px solid #30363d; margin: 1rem 0; }

    .instructions {
      background: #161b22; padding: 0.8rem; border-radius: 4px;
      margin-top: 0.5rem; color: #c9d1d9;
    }
    .instructions ol { margin-left: 1.2rem; }
    .instructions li { margin-bottom: 0.4rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🍳 Yemek Tarifi Önerileri 🍳</h1>
    <p>Elindeki malzemeleri virgülle ayırıp yaz:</p>
    <input type="text" id="ingredients" placeholder="örn: domates, soğan, patates">
    <button id="searchBtn">Tarif Ara</button>
    <p class="contact">İletişim: <a href="mailto:Ali@Siber.NET">Ali@Siber.NET</a></p>
    <!-- Uyarı mesajı buraya gelecek -->
    <p id="warning"></p>
  </div>

  <div class="results-frame" id="results-container">
    <h2>Sonuçlar</h2>
    <p class="hint">Yapılışını görmek için başlığa tıkla</p>
    <div id="message"></div>
    <ul id="results"></ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const apiKey = '117f4267981845d5800cb8de69f44e23';

      async function toEnglish(text) {
        try {
          const res = await fetch(
            `https://translate.googleapis.com/translate_a/single?client=gtx&sl=tr&tl=en&dt=t&q=${encodeURIComponent(text)}`
          );
          const data = await res.json();
          return data[0].map(item => item[0]).join('') || text;
        } catch {
          return text;
        }
      }

      async function toTurkish(text) {
        try {
          const googleRes = await fetch(
            `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=tr&dt=t&q=${encodeURIComponent(text)}`
          );
          const googleData = await googleRes.json();
          return googleData[0].map(item => item[0]).join('') || text;
        } catch {
          return text;
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      const searchBtn = document.getElementById('searchBtn');
      const ingInput = document.getElementById('ingredients');
      const warningP = document.getElementById('warning');
      const msgDiv = document.getElementById('message');
      const ulResults = document.getElementById('results');
      const resultsContainer = document.getElementById('results-container');

      searchBtn.addEventListener('click', async () => {
        const raw = ingInput.value.trim();
        if (!raw) return alert('Lütfen en az bir malzeme giriniz!');

        // TR→EN çevir ve sorgu oluştur
        const ingList = raw.split(',').map(s => s.trim()).filter(Boolean);
        const enList = await Promise.all(ingList.map(toEnglish));
        const query = enList.join(',');

        // Uyarıyı göster
        warningP.textContent = 'Veri tabanı belirtilen malzemeler aranıyor... Biraz zaman alabilir.';
        // 5 saniye bekle
        await sleep(5000);

        // Arama mesajına geçiş
        warningP.textContent = ''; 
        resultsContainer.style.display = 'none';
        msgDiv.textContent = 'Tarif aranıyor… ⏳';
        ulResults.innerHTML = '';

        try {
          const url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${encodeURIComponent(query)}&number=5&apiKey=${apiKey}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          resultsContainer.style.display = 'block';
          if (!data.length) {
            msgDiv.textContent = 'Bu malzemelerle tarif bulunamadı 😕';
            return;
          }
          msgDiv.textContent = `Bulunan ${data.length} tarif:`;

          for (let i = 0; i < data.length; i++) {
            const t = data[i];
            const recipeTitle = t.title || t.name || 'Başlık yok';
            const usedTr = await Promise.all(t.usedIngredients.map(u => toTurkish(u.name || '')));
            const missedTr = await Promise.all(t.missedIngredients.map(u => toTurkish(u.name || '')));

            const li = document.createElement('li');
            const titleEl = document.createElement('div');
            titleEl.className = 'recipe-title';
            titleEl.dataset.id = t.id;
            titleEl.textContent = `${i+1}. ${recipeTitle}`;
            toTurkish(recipeTitle).then(tr => {
              titleEl.textContent = `${i+1}. ${tr}`;
            });
            li.appendChild(titleEl);

            const ingsDiv = document.createElement('div');
            ingsDiv.className = 'ings';

            const usedBlock = document.createElement('div');
            usedBlock.appendChild(Object.assign(document.createElement('strong'), { textContent: 'Kullanılabilir:' }));
            const ulU = document.createElement('ul');
            t.usedIngredients.forEach((u, idx) => {
              const amt = u.measures?.metric?.amount ?? u.amount ?? '';
              const unt = u.measures?.metric?.unitShort ?? u.unit ?? '';
              const name = usedTr[idx] || u.name || '';
              const liU = document.createElement('li');
              liU.textContent = `${name} (${amt} ${unt})`;
              ulU.appendChild(liU);
            });
            usedBlock.appendChild(ulU);

            const missedBlock = document.createElement('div');
            missedBlock.appendChild(Object.assign(document.createElement('strong'), { textContent: 'Eksik:' }));
            const ulM = document.createElement('ul');
            t.missedIngredients.forEach((u, idx) => {
              const amt = u.measures?.metric?.amount ?? u.amount ?? '';
              const unt = u.measures?.metric?.unitShort ?? u.unit ?? '';
              const name = missedTr[idx] || u.name || '';
              const liM = document.createElement('li');
              liM.textContent = `${name} (${amt} ${unt})`;
              ulM.appendChild(liM);
            });
            missedBlock.appendChild(ulM);

            ingsDiv.appendChild(usedBlock);
            ingsDiv.appendChild(missedBlock);
            li.appendChild(ingsDiv);
            li.appendChild(document.createElement('hr'));

            titleEl.onclick = async () => {
              let instrDiv = li.querySelector('.instructions');
              if (instrDiv) {
                instrDiv.style.display = instrDiv.style.display === 'block' ? 'none' : 'block';
                return;
              }
              instrDiv = document.createElement('div');
              instrDiv.className = 'instructions';
              instrDiv.textContent = 'Yükleniyor…';
              li.appendChild(instrDiv);

              try {
                let info = await fetch(`https://api.spoonacular.com/recipes/${t.id}/analyzedInstructions?apiKey=${apiKey}`)
                  .then(r => r.json());
                let steps = info[0]?.steps?.map(s => s.step) || [];

                if (!steps.length) {
                  const info2 = await fetch(`https://api.spoonacular.com/recipes/${t.id}/information?includeNutrition=false&apiKey=${apiKey}`)
                    .then(r => r.json());
                  steps = info2.analyzedInstructions[0]?.steps?.map(s => s.step) || [];
                  if (!steps.length && info2.instructions) {
                    instrDiv.innerHTML = await toTurkish(info2.instructions);
                    return;
                  }
                }

                if (steps.length) {
                  const trs = await Promise.all(steps.map(s => toTurkish(s)));
                  instrDiv.innerHTML = '<ol>' + trs.map(st => `<li>${st}</li>`).join('') + '</ol>';
                } else {
                  instrDiv.textContent = 'Tarif adımları bulunamadı.';
                }
              } catch {
                instrDiv.textContent = 'Adımlar yüklenirken hata oluştu.';
              }
            };

            ulResults.appendChild(li);
          }
        } catch (err) {
          resultsContainer.style.display = 'block';
          msgDiv.textContent = `Hata oluştu: ${err.message}`;
        }
      });
    });
  </script>
</body>
</html>
